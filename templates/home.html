{% extends "base.html" %}

{% block content %}
    <style>
    @import url("https://fonts.googleapis.com/css?family=IBM+Plex+Sans+Devanagari:400,600,500,700,200|Inter:700,800,500,400,600|Roboto:700");

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: "IBM Plex Sans Devanagari", Helvetica;
        background-color: #f8f9fa;
    }

    .dashboard-container {
        max-height: 100vh;
        padding: 16px;
        padding-bottom: 24px;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
    }

    .dashboard-header {
        display: flex;
        align-items: center;
        justify-content: flex-end;
        margin-bottom: 20px;
        flex-shrink: 0;
        height: 40px;
        padding-right: 20px;
    }

    .capital-display {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        padding: 12px 16px;
        background-color: #ffffff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .capital-amount {
        font-weight: 700;
        color: #000000;
        font-size: 18px;
        line-height: 22px;
        margin: 0;
    }

    .capital-label {
        font-weight: 500;
        color: #000000;
        font-size: 11px;
        line-height: 13px;
        margin: 2px 0 0 0;
    }

    .main-content-home {
        display: flex;
        gap: 20px;
        flex: 1;
        min-height: 0;
    }

    .charts-section {
        flex: 2;
        display: flex;
        flex-direction: column;
        gap: 16px;
        min-height: 0;
    }

    .revenue-recovery-card {
        background-color: #ffffff;
        border-radius: 12px;
        border: 0.5px solid #9ca0a4;
        padding: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
    }

    .card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        margin-bottom: 16px;
        flex-shrink: 0;
    }

    .card-title-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .title-row {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .title-with-arrows {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .arrow-icon {
        width: 8px;
        height: 8px;
    }

    .card-title {
        font-weight: 700;
        color: #000000;
        font-size: 20px;
        margin: 0;
    }

    .metrics-row {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .percentage-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 2px 6px;
        background-color: #c0f1e5;
        border-radius: 20px;
    }

    .percentage-text {
        font-family: "Inter", Helvetica;
        font-weight: 800;
        color: #000000;
        font-size: 7px;
        margin: 0;
    }

    .legend {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 2px 6px;
        background-color: #c0f1e5;
        border-radius: 20px;
    }

    .legend-dot {
        width: 5px;
        height: 5px;
        background-color: #ffffff;
        border-radius: 3px;
        border: 1px solid #025864;
    }

    .legend-text {
        font-family: "Inter", Helvetica;
        font-weight: 600;
        color: #000000;
        font-size: 7px;
        margin: 0;
    }

    .card-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 4px;
    }

    .period-display {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }

    .period-display label {
        font-weight: 500;
        color: #000000;
        font-size: 12px;
    }

    .period-display select {
        padding: 4px 8px;
        border: 1px solid #9ca0a4;
        border-radius: 4px;
        font-size: 12px;
        background-color: #ffffff;
    }

    .quarter-text {
        font-weight: 700;
        color: #000000;
        font-size: 20px;
        margin: 0;
    }

    .year-text {
        font-weight: 200;
        color: #000000;
        font-size: 20px;
        margin: 0;
    }

    .control-buttons {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .compare-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3px 8px;
        background-color: #e9f1ef;
        border-radius: 6px;
        border: none;
        cursor: pointer;
        font-family: "Inter", Helvetica;
        font-weight: 500;
        color: #000000;
        font-size: 7px;
    }

    .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        width: 12px;
        height: 12px;
    }

    .chart-container {
        position: relative;
        width: 100%;
        flex: 1;
        min-height: 200px;
        display: flex;
        align-items: stretch;
        justify-content: center;
        margin-bottom: 12px;
    }

    .chart-wrapper {
        position: relative;
        display: flex;
        width: 100%;
        height: 100%;
        padding-left: 50px;
        padding-bottom: 20px;
    }

    .chart-bars {
        position: relative;
        display: flex;
        align-items: flex-end;
        gap: 6px;
        flex: 1;
        padding: 0 10px;
    }

    .bar {
        position: relative;
        width: 23%;
        background-color: #eaedf1;
        border-radius: 6px 6px 0 0;
        align-self: stretch;
        transition: height 0.3s ease;
        min-height: 10px;
    }

    .bar.highlighted {
        background-color: #003049;
    }

    .y-axis {
        position: absolute;
        left: 0;
        top: 0;
        bottom: 20px;
        display: flex;
        flex-direction: column;
        width: 50px;
        justify-content: space-between;
        padding: 0 8px 0 0;
    }

    .y-axis-label {
        font-family: "Inter", Helvetica;
        font-weight: 400;
        color: #7f7f7f;
        font-size: 7px;
        text-align: right;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }

    .chart-indicators {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 20px;
        left: 50px;
        pointer-events: none;
    }

    .x-axis {
        display: flex;
        align-items: center;
        padding: 6px 10px 0 60px;
        border-top: 1px solid #000000;
        flex-shrink: 0;
    }

    .x-axis-label {
        flex: 1;
        text-align: center;
        font-family: "Inter", Helvetica;
        font-weight: 400;
        color: #000000;
        font-size: 7px;
        padding: 4px 6px;
    }

    .capital-summary-card {
        background-color: #f5f2e8;
        border-radius: 12px;
        padding: 20px;
        color: #000000;
        overflow: hidden;
        flex: 1;
        min-height: 0;
        display: flex;
        flex-direction: column;
    }

    .summary-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
        flex-shrink: 0;
    }

    .summary-title {
        font-weight: 600;
        color: #000000;
        font-size: 20px;
        line-height: 24px;
        margin: 0;
    }

    .growth-badge {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 3px 10px;
        background-color: #5dfcaf;
        border-radius: 8px;
        border: 1px solid #025864;
    }

    .growth-text {
        font-weight: 600;
        color: #000000;
        font-size: 10px;
        line-height: 12px;
        margin: 0;
    }

    .progress-bar {
        height: 16px;
        background-color: #58d5b2;
        border-radius: 8px;
        border: 1px solid #003049;
        box-shadow: 0 4px 4px rgba(0, 0, 0, 0.25);
        margin-bottom: 16px;
        overflow: hidden;
        display: flex;
        flex-shrink: 0;
    }

    .progress-fill {
        flex: 1;
        background-color: #1b4764;
        border-radius: 8px;
        border: 1px solid #003049;
    }

    .progress-remaining {
        width: 80px;
    }

    .summary-content {
        display: flex;
        gap: 32px;
        flex: 1;
        min-height: 0;
    }

    .summary-column {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .column-title {
        font-weight: 700;
        color: #000000;
        font-size: 14px;
        line-height: 16px;
        margin: 0 0 8px 0;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .summary-label {
        font-weight: 400;
        color: #000000;
        font-size: 14px;
        line-height: 16px;
        margin: 0;
    }

    .summary-value {
        font-weight: 400;
        color: #000000;
        font-size: 14px;
        line-height: 16px;
        text-align: right;
        margin: 0;
    }

    .summary-total-label {
        font-weight: 500;
        color: #000000;
        font-size: 16px;
        line-height: 20px;
        margin: 0;
    }

    .summary-total-value {
        font-weight: 500;
        color: #000000;
        font-size: 16px;
        line-height: 20px;
        text-align: right;
        margin: 0;
    }

    .view-all-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 8px 20px;
        background-color: #ffffff;
        border-radius: 6px;
        border: 1px solid #003049;
        cursor: pointer;
        margin-top: 16px;
        align-self: flex-end;
        flex-shrink: 0;
    }

    .view-all-text {
        font-family: "Inter", Helvetica;
        font-weight: 700;
        color: #003049;
        font-size: 10px;
        line-height: 12px;
        margin: 0;
    }

    .updates-sidebar {
        flex: 1;
        max-width: 350px;
        padding: 20px;
        border-radius: 12px;
        border: 0.5px solid #9ca0a4;
        background-color: #ffffff;
        display: flex;
        flex-direction: column;
        min-height: 0;
    }

    .updates-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-shrink: 0;
    }

    .updates-title {
        font-weight: 700;
        color: #000000;
        font-size: 20px;
        line-height: 24px;
        margin: 0;
    }

    .updates-controls {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .mark-read-btn {
        font-size: 10px;
        font-weight: 400;
        color: #000000;
        background: none;
        border: none;
        cursor: pointer;
        text-align: center;
        padding: 0;
    }

    .notification-count {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 24px;
        height: 14px;
        padding: 1px 6px;
        background-color: #ec0404;
        border-radius: 16px;
    }

    .count-text {
        font-family: "Roboto", Helvetica;
        font-weight: 700;
        color: #ffffff;
        font-size: 8px;
        line-height: 10px;
        margin: 0;
    }

    .notifications-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        flex: 1;
        overflow-y: auto;
    }

    .notification {
        display: flex;
        flex-direction: column;
        gap: 3px;
        padding: 12px 8px;
        background-color: #ffffff;
        border-radius: 6px;
        border: 1px solid #e2e4e8;
        flex-shrink: 0;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .notification:hover {
        background-color: #f8f9fa;
        border-color: #003049;
        box-shadow: 0 2px 8px rgba(0, 48, 73, 0.1);
    }

    .notification.deleting {
        opacity: 0.5;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }

    .notification-content {
        display: flex;
        gap: 10px;
        align-items: flex-start;
    }

    .notification-icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .notification-body {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
    }

    .notification-text {
        flex: 1;
    }

    .notification-description {
        font-weight: 400;
        color: #000000;
        font-size: 12px;
        line-height: 15px;
        margin: 0;
        word-wrap: break-word;
    }

    .delete-notification-btn {
        position: relative;
        z-index: 10;
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s ease;
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .delete-notification-btn:hover {
        background-color: rgba(220, 53, 69, 0.1);
    }

    .delete-notification-btn svg {
        width: 14px;
        height: 14px;
    }

    .notification-action {
        margin-top: 4px;
    }

    .action-btn {
        background: none;
        border: none;
        cursor: pointer;
        padding: 0;
        font-weight: 500;
        color: #000000;
        font-size: 10px;
        text-decoration: underline;
    }

    .no-notifications {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 40px 20px;
        text-align: center;
        color: #6b7280;
        background-color: #f9fafb;
        border: 2px dashed #d1d5db;
        border-radius: 8px;
        margin: 10px 0;
    }

    .no-notifications-icon {
        width: 48px;
        height: 48px;
        margin-bottom: 16px;
        opacity: 0.7;
    }

    .no-notifications-text {
        font-size: 16px;
        font-weight: 500;
        margin: 0;
        color: #6b7280;
    }

    /* Chart loading state */
    .chart-loading {
        display: flex;
        align-items: center;
        justify-content: center;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.9);
        z-index: 10;
    }

    .loading-spinner {
        width: 30px;
        height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #003049;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    /* Focus styles for accessibility */
    button:focus,
    a:focus {
        outline: 2px solid #4a90e2;
        outline-offset: 2px;
    }

    button:hover {
        opacity: 0.9;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .main-content-home {
            flex-direction: column;
        }

        .updates-sidebar {
            max-width: none;
        }
    }

    @media (max-width: 768px) {
        .dashboard-container {
            padding: 12px;
        }

        .dashboard-header {
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
        }

        .main-content-home {
            gap: 16px;
        }

        .revenue-recovery-card,
        .capital-summary-card,
        .updates-sidebar {
            padding: 16px;
        }

        .summary-content {
            flex-direction: column;
            gap: 16px;
        }

        .no-notifications {
            padding: 30px 15px;
        }

        .no-notifications-icon {
            width: 40px;
            height: 40px;
            margin-bottom: 12px;
        }

        .no-notifications-text {
            font-size: 14px;
        }
    }

    /* Loading overlay and animations */
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
</style>

<div class="dashboard-container">
    <div class="dashboard-header" style="display: flex; align-items: center; justify-content: space-between;">
        <h1 style="font-size: 24px; font-weight: 700; color: #003049;">Bridge Trust</h1>
        <div class="capital-display" style="font-size: 14px; text-align: right;">
            <!--
            <p class="capital-amount" style="margin: 0; font-size: 18px;">K1,054,200.00</p>
            <p class="capital-label" style="margin: 0; font-size: 12px;">Available Capital</p>
            -->
        </div>
    </div>

    <div class="main-content-home">
        <section class="charts-section">
            <div class="revenue-recovery-card">
                <div class="card-header">
                    <div class="card-title-section">
                        <div class="title-row">
                            <div class="title-with-arrows">
                                <svg class="arrow-icon" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 8L5 2L8 8" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                <h2 class="card-title">Interest Earned Per Quarter</h2>
                                <svg class="arrow-icon" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 8L5 2L8 8" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                        </div>
                        <div class="metrics-row">
                            <div class="percentage-badge">
                                <p class="percentage-text" id="growth-percentage">+0%</p>
                            </div>
                            <div class="legend">
                                <div class="legend-dot"></div>
                                <p class="legend-text">Interest Earned by Quarter</p>
                            </div>
                        </div>
                    </div>
                    <div class="card-controls">
                        <div class="period-display">
                            <label for="year-select">Select Year:</label>
                            <select id="year-select" name="year" onchange="updateChart()">
                                <option value="2025" {{ 'selected' if selected_year == 2025 else '' }}>2025</option>
                                <option value="2024" {{ 'selected' if selected_year == 2024 else '' }}>2024</option>
                                <option value="2023" {{ 'selected' if selected_year == 2023 else '' }}>2023</option>
                                <option value="2022" {{ 'selected' if selected_year == 2022 else '' }}>2022</option>
                            </select>
                        </div>
                        <div class="control-buttons">
                            <button class="compare-btn">Compare</button>
                            <button class="icon-btn" aria-label="Settings">
                                <svg viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M6 7.5C6.83 7.5 7.5 6.83 7.5 6C7.5 5.17 6.83 4.5 6 4.5C5.17 4.5 4.5 5.17 4.5 6C4.5 6.83 5.17 7.5 6 7.5Z" stroke="#000" stroke-width="0.75"/>
                                </svg>
                            </button>
                            <button class="icon-btn" aria-label="Maximize">
                                <svg viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M2 2H10V10H2V2Z" stroke="#000" stroke-width="0.75"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-loading" id="chart-loading" style="display: none;">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="chart-wrapper">
                        <div class="y-axis" id="y-axis">
                            <!-- Y-axis labels will be populated by JavaScript -->
                        </div>
                        <div class="chart-bars" id="chart-bars">
                            <!-- Bars will be populated by JavaScript -->
                        </div>
                    </div>
                    <div class="x-axis">
                        <div class="x-axis-label">Q1</div>
                        <div class="x-axis-label">Q2</div>
                        <div class="x-axis-label">Q3</div>
                        <div class="x-axis-label">Q4</div>
                    </div>
                </div>
            </div>

            <div class="capital-summary-card">
                <div class="summary-header">
                    <h2 class="summary-title">Disbursed Capital Summary</h2>
                    <div class="growth-badge">
                        <p class="growth-text">+{{ (nominal_rate * 100) | round(2) }}% per month</p>
                    </div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill"></div>
                    <div class="progress-remaining"></div>
                </div>

                <div class="summary-content">
                    <div class="summary-column">
                        <h3 class="column-title">What you've given out*</h3>
                        <div class="summary-row">
                            <p class="summary-label">Principal</p>
                            <p class="summary-value">{{ total_principal_given }}</p>
                        </div>
                        <div class="summary-row">
                            <p class="summary-label">Interest earned</p>
                            <p class="summary-value">{{ interest_earned }}</p>
                        </div>
                        <div class="summary-row">
                            <p class="summary-total-label">Account Receivables</p>
                            <p class="summary-total-value">{{ total_receivables }}</p>
                        </div>
                    </div>

                    <div class="summary-column">
                        <h3 class="column-title">What you're still owed*</h3>
                        <div class="summary-row">
                            <p class="summary-label">Principal</p>
                            <p class="summary-value">{{outstanding_principal_balance}}</p>
                        </div>
                        <div class="summary-row">
                            <p class="summary-label">Interest</p>
                            <p class="summary-value">{{outstanding_interest }}</p>
                        </div>
                        <div class="summary-row">
                            <p class="summary-total-label">Total Balance</p>
                            <p class="summary-total-value">{{total_owed}}</p>
                        </div>
                    </div>
                </div>

                <a href="{{ url_for('organisation_transactions') }}">
                    <button class="view-all-btn">
                        <span class="view-all-text">View all Transactions</span>
                    </button>
                </a>
            </div>
        </section>

        <aside class="updates-sidebar">
            <div class="updates-header">
                <h2 class="updates-title">Notifications</h2>
                <div class="updates-controls">
                    <button class="mark-read-btn">Mark all as read</button>
                    <div class="notification-count">
                        <span class="count-text">{{ notifications|length if notifications else 0 }}</span>
                    </div>
                </div>
            </div>

            <div class="notifications-list">
                {% if notifications %}
                    {% for notification in notifications[:3] %}
                    <a href="#" data-notification-id="{{ notification.id }}" data-borrower-id="{{ notification.borrower_id }}" data-user-id="{{ notification.user_id }}" data-request-id="{{ notification.request_id }}" data-created-at="{{ notification.created_at }}" style="text-decoration: none; color: inherit;">
                        <article class="notification" id="notification-{{ notification.id }}">
                            <div class="notification-content">
                                <svg class="notification-icon" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="8" cy="8" r="7" fill="none" stroke="#FF9800" stroke-width="1"/>
                                    <path d="M8 4V8L10 10" stroke="#FF9800" stroke-width="1" stroke-linecap="round"/>
                                </svg>
                                <div class="notification-body">
                                    <div class="notification-text">
                                        <p class="notification-description">
                                            {{ notification.notification | replace('\n', '<br>') | safe }}
                                        </p>
                                    </div>
                                </div>
                                <button class="close-btn delete-notification-btn"
                                        data-notification-id="{{ notification.id }}"
                                        aria-label="Close notification"
                                        onclick="deleteNotification(event, '{{ notification.id }}')">
                                    <svg viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M10.5 3.5L3.5 10.5M3.5 3.5L10.5 10.5" stroke="#666" stroke-width="1.5" stroke-linecap="round"/>
                                    </svg>
                                </button>
                            </div>
                        </article>
                    </a>
                    {% endfor %}
                {% else %}
                    <div class="no-notifications" id="no-notifications-message">
                        <svg class="no-notifications-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <line x1="9" y1="9" x2="15" y2="15" stroke="#9ca3af" stroke-width="2" stroke-linecap="round"/>
                            <line x1="15" y1="9" x2="9" y2="15" stroke="#9ca3af" stroke-width="2" stroke-linecap="round"/>
                        </svg>
                        <p class="no-notifications-text">You have no notifications</p>
                    </div>
                {% endif %}
            </div>
        </aside>
    </div>
</div>

<!-- Loading overlay -->
<div id="notification-loading" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
        <div style="display: flex; align-items: center; gap: 10px;">
            <div style="width: 20px; height: 20px; border: 2px solid #f3f3f3; border-top: 2px solid #007bff; border-radius: 50%; animation: spin 1s linear infinite;"></div>
            <span>Deleting notification...</span>
        </div>
    </div>
</div>

<script>
// Store the current interest data
let currentInterestData = {{ interest_per_quarter | tojson }};

// Chart configuration
const chartConfig = {
    colors: {
        default: '#eaedf1',
        highlighted: '#003049'
    }
};

// Initialize the chart on page load
document.addEventListener('DOMContentLoaded', function() {
    renderChart(currentInterestData);
});

function formatCurrency(amount) {
    return 'K' + parseFloat(amount).toLocaleString('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
    });
}

function calculateGrowthPercentage(data) {
    const values = Object.values(data);
    const total = values.reduce((sum, val) => sum + val, 0);

    // Simple growth calculation - you can modify this logic based on your needs
    const average = total / 4;
    const lastQuarter = values[3]; // Q4

    if (average === 0) return 0;
    const growth = ((lastQuarter - average) / average * 100).toFixed(0);
    return growth > 0 ? `+${growth}%` : `${growth}%`;
}

function renderChart(data) {
    const chartBars = document.getElementById('chart-bars');
    const yAxis = document.getElementById('y-axis');
    const growthElement = document.getElementById('growth-percentage');

    if (!chartBars || !yAxis || !data) {
        console.error('Chart elements not found or data is null');
        return;
    }

    // Clear existing content
    chartBars.innerHTML = '';
    yAxis.innerHTML = '';

    // Get values and find max for scaling
    const quarters = ['first quarter', 'second quarter', 'third quarter', 'fourth quarter'];
    const values = quarters.map(q => data[q] || 0);
    const maxValue = Math.max(...values, 1); // Ensure at least 1 to avoid division by zero

    // Create Y-axis labels (5 levels)
    const yAxisLevels = 5;
    for (let i = 0; i < yAxisLevels; i++) {
        const value = (maxValue / (yAxisLevels - 1)) * (yAxisLevels - 1 - i);
        const label = document.createElement('div');
        label.className = 'y-axis-label';
        label.textContent = formatCurrency(value);
        yAxis.appendChild(label);
    }

    // Create bars
    quarters.forEach((quarter, index) => {
        const value = values[index];
        const height = maxValue > 0 ? (value / maxValue) * 100 : 10;

        const bar = document.createElement('div');
        bar.className = 'bar';
        bar.style.height = `${Math.max(height, 5)}%`; // Minimum 5% height for visibility

        // Highlight the bar with highest value
        if (value === Math.max(...values) && value > 0) {
            bar.classList.add('highlighted');
        }

        // Add hover effect with value display
        bar.title = `${quarter.charAt(0).toUpperCase() + quarter.slice(1)}: ${formatCurrency(value)}`;

        chartBars.appendChild(bar);
    });

    // Update growth percentage
    if (growthElement) {
        growthElement.textContent = calculateGrowthPercentage(data);
    }
}

function updateChart() {
    const yearSelect = document.getElementById('year-select');
    const selectedYear = yearSelect.value;
    const loadingElement = document.getElementById('chart-loading');

    // Show loading state
    if (loadingElement) {
        loadingElement.style.display = 'flex';
    }

    // Fetch new data
    fetch(`/get_interest_data/${selectedYear}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(result => {
        // Hide loading state
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }

        if (result.success) {
            currentInterestData = result.data;
            renderChart(currentInterestData);
        } else {
            console.error('Error fetching data:', result.error);
            showFlashMessage('Failed to load interest data for the selected year.', 'error');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);

        // Hide loading state
        if (loadingElement) {
            loadingElement.style.display = 'none';
        }

        showFlashMessage('An error occurred while fetching chart data.', 'error');
    });
}

// Notification deletion functions (keeping existing functionality)
function deleteNotification(event, notificationId) {
    // Prevent the parent link from being triggered
    event.preventDefault();
    event.stopPropagation();

    // Get the notification element
    const notificationElement = document.getElementById(`notification-${notificationId}`);
    const loadingOverlay = document.getElementById('notification-loading');

    // Add visual feedback
    if (notificationElement) {
        notificationElement.classList.add('deleting');
    }

    // Show loading overlay
    if (loadingOverlay) {
        loadingOverlay.style.display = 'block';
    }

    // Send DELETE request to Flask route
    fetch(`/delete_notification/${notificationId}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        // Hide loading overlay
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }

        if (response.ok) {
            // Success - remove the notification from DOM
            if (notificationElement) {
                notificationElement.style.transition = 'all 0.3s ease';
                notificationElement.style.transform = 'translateX(100%)';
                notificationElement.style.opacity = '0';

                setTimeout(() => {
                    notificationElement.remove();

                    // Check if there are no notifications left
                    const remainingNotifications = document.querySelectorAll('.notification');
                    if (remainingNotifications.length === 0) {
                        const notificationsList = document.querySelector('.notifications-list');
                        if (notificationsList) {
                            notificationsList.innerHTML = `
                                <div class="no-notifications" id="no-notifications-message">
                                    <svg class="no-notifications-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M13.73 21C13.5542 21.3031 13.3019 21.5547 12.9982 21.7295C12.6946 21.9044 12.3504 21.9965 12 21.9965C11.6496 21.9965 11.3054 21.9044 11.0018 21.7295C10.6982 21.5547 10.4458 21.3031 10.27 21" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <line x1="9" y1="9" x2="15" y2="15" stroke="#9ca3af" stroke-width="2" stroke-linecap="round"/>
                                        <line x1="15" y1="9" x2="9" y2="15" stroke="#9ca3af" stroke-width="2" stroke-linecap="round"/>
                                    </svg>
                                    <p class="no-notifications-text">You have no notifications</p>
                                </div>
                            `;
                        }

                        // Update notification count to 0
                        const countElement = document.querySelector('.count-text');
                        if (countElement) {
                            countElement.textContent = '0';
                        }
                    } else {
                        // Update notification count
                        const countElement = document.querySelector('.count-text');
                        if (countElement) {
                            countElement.textContent = remainingNotifications.length.toString();
                        }
                    }
                }, 300);
            }

            // Show success message
            showFlashMessage('Notification deleted successfully.', 'success');
        } else {
            // Error handling
            console.error('Failed to delete notification');

            // Remove deleting class to restore normal state
            if (notificationElement) {
                notificationElement.classList.remove('deleting');
            }

            // Show error message
            showFlashMessage('Failed to delete notification. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);

        // Hide loading overlay
        if (loadingOverlay) {
            loadingOverlay.style.display = 'none';
        }

        // Remove deleting class to restore normal state
        if (notificationElement) {
            notificationElement.classList.remove('deleting');
        }

        // Show error message
        showFlashMessage('An error occurred while deleting the notification.', 'error');
    });
}

function showFlashMessage(message, type) {
    // Create flash message element
    const flashDiv = document.createElement('div');
    flashDiv.className = `flash-message flash-${type}`;
    flashDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        z-index: 1001;
        max-width: 300px;
        word-wrap: break-word;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-size: 14px;
        font-weight: 500;
    `;

    if (type === 'success') {
        flashDiv.style.backgroundColor = '#10b981';
    } else if (type === 'error') {
        flashDiv.style.backgroundColor = '#ef4444';
    }

    flashDiv.textContent = message;

    document.body.appendChild(flashDiv);

    // Auto-remove after 5 seconds
    setTimeout(() => {
        flashDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (flashDiv.parentNode) {
                flashDiv.parentNode.removeChild(flashDiv);
            }
        }, 300);
    }, 5000);
}

// Optional: Add keyboard support for accessibility
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const loadingOverlay = document.getElementById('notification-loading');
        if (loadingOverlay && loadingOverlay.style.display === 'block') {
            // Don't hide loading overlay on escape - let the request complete
            return;
        }
    }
});

// Optional: Click anywhere to dismiss flash messages
document.addEventListener('click', function(event) {
    if (event.target.classList.contains('flash-message')) {
        event.target.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (event.target.parentNode) {
                event.target.parentNode.removeChild(event.target);
            }
        }, 300);
    }
});
</script>

{% endblock %}