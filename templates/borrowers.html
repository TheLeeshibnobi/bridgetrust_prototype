{% extends "base.html" %}

{% block content %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Setting a default font for better readability */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* A light grey background to match the image */
        }

        /* Custom scrollbar styles */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            background-color: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* Hide default scrollbar for the table wrapper */
        .table-wrapper::-webkit-scrollbar {
            display: none;
        }

        /* Add a subtle inset box-shadow to indicate the scrollable area */
        .table-wrapper {
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
        }

        /* Ensure slide panel is above everything */
        .slide-panel {
            z-index: 9999;
        }

        /* File upload styles */
        .file-drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }

        .file-drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .file-preview {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
        }

        .file-item {
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-2 sm:p-4">
    <div class="w-full max-w-none bg-white rounded-xl shadow-lg overflow-hidden flex flex-col min-h-screen">

        <!-- Header Section -->
        <div class="flex items-center justify-between p-4 border-b border-gray-200">
            <h1 class="text-2xl font-bold text-gray-800">Borrower Management</h1>
            <div class="flex items-center space-x-2">
                <!-- Dropdown Icon -->
                <button class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                    </svg>
                </button>
                <div class="w-3 h-3 bg-red-500 rounded-full"></div>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="flex-1 flex flex-col p-4 overflow-y-auto custom-scrollbar">

            <!-- Top Controls: Search, Import/Export, Add New -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-4 sm:space-y-0 mb-6">
                <input type="text" placeholder="Search" class="flex-1 max-w-md w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                <div class="flex space-x-2">
                    <button class="flex items-center px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        <!-- Import/Export Icon (Inline SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                        </svg>
                        Import/Export
                    </button>
                    <button id="addNewBtn" class="flex items-center px-4 py-2 bg-black text-white rounded-lg text-sm font-medium hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-black transition duration-150 ease-in-out">
                        <!-- Add New Icon (Inline SVG) -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        Add New
                    </button>
                </div>
            </div>

            <!-- Tabs Section -->
            <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

            <div class="border-b border-gray-200 mb-6" x-data="{ open: false }">
                <nav class="-mb-px flex space-x-8 items-center" aria-label="Tabs">
                    <a href="#"
                       class="border-b-2 border-green-500 text-green-600 whitespace-nowrap py-4 px-1 text-sm font-medium"
                       aria-current="page">
                        All
                    </a>

                    {% for org in organisations[:3] %}
                        <a href="#"
                           class="border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium">
                            {{ org.name }}
                        </a>
                    {% endfor %}

                    <!-- View More Button -->
                    {% if organisations|length > 3 %}
                    <div class="relative">
                        <button @click="open = !open"
                                class="text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap py-4 px-1 text-sm font-medium focus:outline-none">
                            View More
                        </button>

                        <!-- Dropdown -->
                        <div x-show="open"
                             @click.outside="open = false"
                             class="absolute right-0 mt-2 w-64 bg-white border border-gray-200 rounded-md shadow-lg z-10">
                            <ul class="py-1">
                                {% for org in organisations[3:] %}
                                    <li>
                                        <a href="#"
                                           class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                            {{ org.name }}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                </nav>
            </div>

            <!-- Table Section -->
            <div class="relative overflow-x-auto rounded-lg shadow border border-gray-200 flex-1">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="p-4 w-4">
                                <input id="checkbox-all" type="checkbox" class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2">
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Organization
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Borrower Name
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Nrc Number/Passport
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Balance
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Credit Score
                            </th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                <!-- Plus icon -->
                                <button class="text-gray-400 hover:text-gray-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                                    </svg>
                                </button>
                            </th>
                        </tr>
                    </thead>

                    <tbody class="bg-white divide-y divide-gray-200" id="borrowers-table-body">
                        {% for borrower in borrowers %}
                        <!-- Visible Row -->
                        <tr class="borrower-row cursor-pointer hover:bg-gray-50 transition duration-150 ease-in-out">
                            <td class="p-4 w-4">
                                <input id="checkbox-{{ loop.index }}" type="checkbox"
                                       class="w-4 h-4 text-green-600 bg-gray-100 border-gray-300 rounded focus:ring-green-500 focus:ring-2">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                {{ borrower.organisation_name }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ borrower.first_name }} {{ borrower.last_name }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ borrower.nrc_number }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                {{ borrower.latest_balance }}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 flex items-center">
                                {{ borrower.status or 'N/A' }}
                                <svg class="h-4 w-4 ml-2 text-gray-400 transform transition-transform duration-200 expand-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                </svg>
                            </td>
                            <td></td>
                        </tr>

                        <!-- Hidden Detail Row -->
                        <tr class="hidden detailed-info-row">
                            <td colspan="7" class="p-4 bg-gray-50 rounded-b-lg border-t border-gray-200">
                                <div class="bg-white p-6 rounded-lg shadow-inner">
                                    <h3 class="font-bold text-gray-900 mb-4">Borrower Details</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Email</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.email }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Phone</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.phone }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Date Of Birth</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.date_of_birth or '-' }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Address</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.address or 'N/A' }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Balance Amount</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">ZMW {{ borrower.latest_balance or '0' }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Number Of Remaining Payments</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.total_remaining_payments }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Occupation</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.occupation }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Balance Due Date</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.due_date or 'N/A' }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Date of enrollment</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower.created_at }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Next Of KIN: Name</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower['next_of_kin']['first_name'] }}{{ borrower['next_of_kin']['last_name'] }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Next Of KIN: Phone</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower['next_of_kin']['phone'] }}</p>
                                        </div>
                                        <div>
                                            <p class="text-xs font-medium text-gray-500">Next Of KIN: Email</p>
                                            <p class="text-sm font-semibold text-gray-900 mt-1">{{ borrower['next_of_kin']['email'] }}</p>
                                        </div>
                                    </div>
                                    <div class="mt-6 text-right">
                                        <button class="edit-btn text-sm font-medium text-blue-600 hover:text-blue-800"
                                                data-borrower-id="{{ borrower.id }}"
                                                data-borrower-data="{{ borrower | tojson | e }}">
                                            Edit Details
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Slide-out Form Panel -->
    <div id="slidePanel" class="slide-panel fixed inset-y-0 right-0 w-96 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
        <div class="p-6">
            <!-- Header -->
            <div class="flex items-center justify-between mb-6">
                <h2 id="panelTitle" class="text-xl font-bold text-gray-900">Add New Borrower</h2>
                <button id="closePanelBtn" type="button" class="text-gray-400 hover:text-gray-600 focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>

            <form id="borrowerForm" class="space-y-6" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}"/>
                <input type="hidden" id="borrowerId" name="borrower_id" value="">
                <input type="hidden" id="formMode" name="form_mode" value="add">

                <!-- Document Uploads Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Document Uploads</h3>
                    <div class="space-y-3">
                        <!-- Identity Document Upload -->
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <input type="radio" name="document_type" value="identity" class="mr-3" id="identity-radio">
                                    <label for="identity-radio" class="text-sm text-gray-700">Proof of Identity eg. NRC/passport</label>
                                </div>
                                <button type="button" class="upload-btn px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200" data-type="identity">
                                    Upload
                                </button>
                            </div>
                            <input type="file" id="identity-upload" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple>
                            <div id="identity-preview" class="file-preview hidden mt-3 p-3 rounded-lg">
                                <div class="text-xs font-medium text-gray-500 mb-2">Selected Files:</div>
                                <div id="identity-files" class="space-y-2"></div>
                            </div>
                        </div>

                        <!-- Residence Document Upload -->
                        <div class="border border-gray-200 rounded-lg p-3">
                            <div class="flex items-center justify-between mb-3">
                                <div class="flex items-center">
                                    <input type="radio" name="document_type" value="residence" class="mr-3" id="residence-radio">
                                    <label for="residence-radio" class="text-sm text-gray-700">Proof of Residence eg. Utility Bill</label>
                                </div>
                                <button type="button" class="upload-btn px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200" data-type="residence">
                                    Upload
                                </button>
                            </div>
                            <input type="file" id="residence-upload" class="hidden" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" multiple>
                            <div id="residence-preview" class="file-preview hidden mt-3 p-3 rounded-lg">
                                <div class="text-xs font-medium text-gray-500 mb-2">Selected Files:</div>
                                <div id="residence-files" class="space-y-2"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Personal Information Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Personal Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name*</label>
                            <input type="text" name="first_name" id="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">NRC/Passport or Driver's License</label>
                            <input type="text" name="nrc_number" id="nrcNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name*</label>
                            <input type="text" name="last_name" id="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" name="email" id="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                            <input type="tel" name="phone" id="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Date of Birth</label>
                            <input type="date" name="date_of_birth" id="dateOfBirth" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Gender</label>
                            <select name="gender" id="gender" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Gender</option>
                                <option value="male">Male</option>
                                <option value="female">Female</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Residential Address</label>
                            <input type="text" name="address" id="address" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Select Organisation</label>
                            <select name="organisation_id" id="organisationId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">Select Org</option>
                                {% for org in organisations %}
                                    <option value="{{ org.id }}">{{ org.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Occupation</label>
                            <input type="text" name="occupation" id="occupation" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Employee ID</label>
                            <input type="text" name="employee_id" id="employeeId" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Next of Kin Information Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Next of Kin Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">First Name*</label>
                            <input type="text" name="kin_first_name" id="kinFirstName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Email Address</label>
                            <input type="email" name="kin_email" id="kinEmail" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Last Name*</label>
                            <input type="text" name="kin_last_name" id="kinLastName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Mobile Number</label>
                            <input type="tel" name="kin_phone" id="kinPhone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Borrower Bank Information Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Borrower Bank Information</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Name of Bank</label>
                            <input type="text" name="bank_name" id="bankName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Branch Name</label>
                            <input type="text" name="branch_name" id="branchName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Branch Swift Code</label>
                            <input type="text" name="swift_code" id="swiftCode" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Account Number</label>
                            <input type="text" name="account_number" id="accountNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="flex justify-between pt-6 border-t border-gray-200">
                    <button type="button" id="backBtn" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500">
                        Back
                    </button>
                    <button type="submit" id="submitBtn" class="px-6 py-2 text-sm font-medium text-white bg-black rounded-md hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black">
                        Submit
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <script>
        // Global object to store uploaded files
        window.uploadedFiles = {
            identity: [],
            residence: []
        };

        // Global variable to track form mode
        let currentFormMode = 'add';
        let currentBorrowerId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const borrowerRows = document.querySelectorAll('.borrower-row');
            const addNewBtn = document.getElementById('addNewBtn');
            const slidePanel = document.getElementById('slidePanel');
            const overlay = document.getElementById('overlay');
            const closePanelBtn = document.getElementById('closePanelBtn');
            const backBtn = document.getElementById('backBtn');
            const borrowerForm = document.getElementById('borrowerForm');
            const panelTitle = document.getElementById('panelTitle');
            const submitBtn = document.getElementById('submitBtn');

            // Handle expandable rows
            borrowerRows.forEach(row => {
                row.addEventListener('click', (e) => {
                    // Prevent row expansion when clicking edit button
                    if (e.target.closest('.edit-btn')) {
                        return;
                    }

                    const detailedRow = row.nextElementSibling;
                    if (detailedRow && detailedRow.classList.contains('detailed-info-row')) {
                        detailedRow.classList.toggle('hidden');
                        const icon = row.querySelector('.expand-icon');
                        if (icon) {
                            icon.classList.toggle('rotate-180');
                        }
                    }
                });
            });

            // Handle edit button clicks
            document.addEventListener('click', async (e) => {
                if (e.target.closest('.edit-btn')) {
                    const editBtn = e.target.closest('.edit-btn');
                    const borrowerId = editBtn.getAttribute('data-borrower-id');

                    try {
                        // Show loading state
                        editBtn.textContent = 'Loading...';
                        editBtn.disabled = true;

                        // Fetch fresh borrower data from the server
                        const response = await fetch(`/get_borrower_data/${borrowerId}`);

                        if (!response.ok) {
                            throw new Error(`Failed to fetch borrower data: ${response.status}`);
                        }

                        const borrowerData = await response.json();
                        console.log('Fetched borrower data:', borrowerData);

                        // Open edit panel with the fetched data
                        openEditPanel(borrowerId, borrowerData);

                    } catch (error) {
                        console.error('Error fetching borrower data:', error);
                        alert('Error loading borrower data: ' + error.message);
                    } finally {
                        // Reset button state
                        editBtn.textContent = 'Edit Details';
                        editBtn.disabled = false;
                    }
                }
            });

            // Function to open panel in edit mode
            function openEditPanel(borrowerId, borrowerData) {
                currentFormMode = 'edit';
                currentBorrowerId = borrowerId;

                // Update panel title and button
                panelTitle.textContent = 'Edit Borrower';
                submitBtn.textContent = 'Update';

                // Set hidden form fields
                document.getElementById('borrowerId').value = borrowerId;
                document.getElementById('formMode').value = 'edit';

                // Populate form fields with borrower data
                populateFormFields(borrowerData);

                // Open the panel
                openPanel();
            }

            // Function to populate form fields
            function populateFormFields(borrowerData) {
                // Personal Information
                document.getElementById('firstName').value = borrowerData.first_name || '';
                document.getElementById('lastName').value = borrowerData.last_name || '';
                document.getElementById('nrcNumber').value = borrowerData.nrc_number || '';
                document.getElementById('email').value = borrowerData.email || '';
                document.getElementById('phone').value = borrowerData.phone || '';
                document.getElementById('dateOfBirth').value = borrowerData.date_of_birth || '';
                document.getElementById('gender').value = borrowerData.gender || '';
                document.getElementById('address').value = borrowerData.address || '';
                document.getElementById('organisationId').value = borrowerData.organisation_id || '';
                document.getElementById('occupation').value = borrowerData.occupation || '';
                document.getElementById('employeeId').value = borrowerData.employee_id || '';

                // Next of Kin Information
                if (borrowerData.next_of_kin) {
                    document.getElementById('kinFirstName').value = borrowerData.next_of_kin.first_name || '';
                    document.getElementById('kinLastName').value = borrowerData.next_of_kin.last_name || '';
                    document.getElementById('kinEmail').value = borrowerData.next_of_kin.email || '';
                    document.getElementById('kinPhone').value = borrowerData.next_of_kin.phone || '';
                }

                // Bank Information
                if (borrowerData.bank_info) {
                    document.getElementById('bankName').value = borrowerData.bank_info.bank_name || '';
                    document.getElementById('branchName').value = borrowerData.bank_info.branch_name || '';
                    document.getElementById('swiftCode').value = borrowerData.bank_info.swift_code || '';
                    document.getElementById('accountNumber').value = borrowerData.bank_info.account_number || '';
                }
            }

            // Function to clear form fields
            function clearFormFields() {
                borrowerForm.reset();
                document.getElementById('borrowerId').value = '';
                document.getElementById('formMode').value = 'add';

                // Clear uploaded files
                window.uploadedFiles = {
                    identity: [],
                    residence: []
                };

                // Hide all preview sections
                document.getElementById('identity-preview').classList.add('hidden');
                document.getElementById('residence-preview').classList.add('hidden');
            }

            // File upload handling
            function setupFileUpload() {
                const uploadButtons = document.querySelectorAll('.upload-btn');

                uploadButtons.forEach(button => {
                    const documentType = button.getAttribute('data-type');
                    const fileInput = document.getElementById(`${documentType}-upload`);
                    const previewDiv = document.getElementById(`${documentType}-preview`);
                    const filesContainer = document.getElementById(`${documentType}-files`);

                    // Button click to trigger file input
                    button.addEventListener('click', () => {
                        fileInput.click();
                    });

                    // Handle file selection
                    fileInput.addEventListener('change', (e) => {
                        const files = Array.from(e.target.files);
                        if (files.length > 0) {
                            processFiles(files, documentType, previewDiv, filesContainer);
                            // Auto-select the corresponding radio button
                            document.getElementById(`${documentType}-radio`).checked = true;
                        }
                    });
                });
            }

            function processFiles(files, documentType, previewDiv, filesContainer) {
                // Clear existing files for this document type
                window.uploadedFiles[documentType] = [];
                filesContainer.innerHTML = '';

                files.forEach((file, index) => {
                    // Create file object to store
                    const fileObject = {
                        id: generateFileId(),
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        lastModified: file.lastModified,
                        documentType: documentType,
                        file: file // Store the actual file object
                    };

                    // Add to global storage
                    window.uploadedFiles[documentType].push(fileObject);

                    // Create preview element
                    const fileElement = createFilePreviewElement(fileObject, documentType, index);
                    filesContainer.appendChild(fileElement);
                });

                // Show preview section
                previewDiv.classList.remove('hidden');

                console.log('Updated uploaded files:', window.uploadedFiles);
            }

            function createFilePreviewElement(fileObject, documentType, index) {
                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-item flex items-center justify-between p-2 bg-white rounded border';

                fileDiv.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <div class="flex-shrink-0">
                            ${getFileIcon(fileObject.type)}
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${fileObject.name}</p>
                            <p class="text-xs text-gray-500">${formatFileSize(fileObject.size)}</p>
                        </div>
                    </div>
                    <button type="button" class="remove-file-btn text-red-500 hover:text-red-700 p-1" data-type="${documentType}" data-id="${fileObject.id}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                `;

                // Add remove functionality
                const removeBtn = fileDiv.querySelector('.remove-file-btn');
                removeBtn.addEventListener('click', () => {
                    removeFile(fileObject.id, documentType);
                    fileDiv.remove();

                    // Hide preview if no files left
                    if (window.uploadedFiles[documentType].length === 0) {
                        document.getElementById(`${documentType}-preview`).classList.add('hidden');
                    }
                });

                return fileDiv;
            }

            function removeFile(fileId, documentType) {
                window.uploadedFiles[documentType] = window.uploadedFiles[documentType].filter(
                    file => file.id !== fileId
                );
                console.log('File removed. Updated files:', window.uploadedFiles);
            }

            function generateFileId() {
                return 'file_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            }

            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function getFileIcon(fileType) {
                if (fileType.startsWith('image/')) {
                    return `<svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>`;
                } else if (fileType === 'application/pdf') {
                    return `<svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                    </svg>`;
                } else {
                    return `<svg class="w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>`;
                }
            }

            // Function to get all uploaded files for form submission
            function getAllUploadedFiles() {
                const allFiles = [];
                Object.keys(window.uploadedFiles).forEach(documentType => {
                    window.uploadedFiles[documentType].forEach(fileObj => {
                        allFiles.push({
                            id: fileObj.id,
                            name: fileObj.name,
                            size: fileObj.size,
                            type: fileObj.type,
                            documentType: fileObj.documentType,
                            file: fileObj.file
                        });
                    });
                });
                return allFiles;
            }

            // Handle slide panel
            function openPanel() {
                slidePanel.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closePanel() {
                slidePanel.classList.add('translate-x-full');
                overlay.classList.add('hidden');
                document.body.style.overflow = 'auto';

                // Reset form to add mode
                currentFormMode = 'add';
                currentBorrowerId = null;
                panelTitle.textContent = 'Add New Borrower';
                submitBtn.textContent = 'Submit';

                // Clear form fields
                clearFormFields();
            }

            // Add New button click
            addNewBtn.addEventListener('click', () => {
                currentFormMode = 'add';
                currentBorrowerId = null;
                panelTitle.textContent = 'Add New Borrower';
                submitBtn.textContent = 'Submit';
                clearFormFields();
                openPanel();
            });

            closePanelBtn.addEventListener('click', closePanel);
            backBtn.addEventListener('click', closePanel);
            overlay.addEventListener('click', closePanel);

            // Initialize file upload functionality
            setupFileUpload();

            // Handle form submission
            borrowerForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                console.log('Form submission started, mode:', currentFormMode);

                try {
                    // Get form data
                    const formData = new FormData(borrowerForm);

                    // Get uploaded files
                    const uploadedFiles = getAllUploadedFiles();
                    console.log('Uploaded files:', uploadedFiles);

                    // Create FormData for submission
                    const submitFormData = new FormData();

                    // Add regular form fields
                    for (const [key, value] of formData.entries()) {
                        if (key !== 'uploaded_files') {
                            submitFormData.append(key, value);
                            console.log(`Form field: ${key} = ${value}`);
                        }
                    }

                    // Add files to FormData
                    uploadedFiles.forEach((fileObj, index) => {
                        submitFormData.append(`file_${index}`, fileObj.file);
                        submitFormData.append(`file_${index}_type`, fileObj.documentType);
                        submitFormData.append(`file_${index}_name`, fileObj.name);
                        console.log(`File ${index}: ${fileObj.name} (${fileObj.documentType})`);
                    });

                    submitFormData.append('total_files', uploadedFiles.length.toString());
                    console.log('Total files:', uploadedFiles.length);

                    // Show loading state
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = currentFormMode === 'edit' ? 'Updating...' : 'Submitting...';
                    submitBtn.disabled = true;

                    console.log('Sending request to server...');

                    // Determine endpoint based on form mode
                    const endpoint = currentFormMode === 'edit' ? '/update_borrower' : '/add_borrower';

                    const response = await fetch(endpoint, {
                        method: 'POST',
                        body: submitFormData
                    });

                    console.log('Response status:', response.status);
                    console.log('Response headers:', Object.fromEntries(response.headers.entries()));

                    // Check if response is JSON
                    const contentType = response.headers.get('content-type');
                    console.log('Content-Type:', contentType);

                    if (!contentType || !contentType.includes('application/json')) {
                        // Response is not JSON, get text instead
                        const responseText = await response.text();
                        console.error('Non-JSON response received:', responseText);
                        throw new Error(`Server returned HTML instead of JSON. Status: ${response.status}. Response: ${responseText.substring(0, 200)}...`);
                    }

                    const responseData = await response.json();
                    console.log('Response data:', responseData);

                    if (response.ok && responseData.success) {
                        alert(currentFormMode === 'edit' ? 'Borrower updated successfully!' : 'Borrower added successfully!');
                        closePanel();
                        // Reload the page to show the changes
                        window.location.reload();
                    } else {
                        alert('Error: ' + (responseData.message || `Failed to ${currentFormMode} borrower`));
                    }

                } catch (error) {
                    console.error('Form submission error:', error);
                    alert('Error submitting form: ' + error.message);
                } finally {
                    // Reset button state
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            });

            // Handle ESC key to close panel
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !slidePanel.classList.contains('translate-x-full')) {
                    closePanel();
                }
            });
        });

        // Utility function to access uploaded files from outside
        window.getUploadedFiles = function() {
            return window.uploadedFiles;
        };

        // Function to manually add file (useful for testing or programmatic addition)
        window.addFileToUpload = function(file, documentType) {
            if (!window.uploadedFiles[documentType]) {
                window.uploadedFiles[documentType] = [];
            }

            const fileObject = {
                id: 'file_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now(),
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified,
                documentType: documentType,
                file: file
            };

            window.uploadedFiles[documentType].push(fileObject);
            return fileObject.id;
        };
    </script>
</body>
{% endblock %}